# CSB Builtin Benchmarks

The benchmarks in CSB are mostly auto-generated by [bm-generator][].
Each benchmark is a C header under (bench/targets). Each header is compiled with `benchmark.c`
in a separate binary. These binaries represent an application/benchmark pool
to be run by [bm-runner][].

## Compiling

[bm-runner][] compiles and builds the builtin benchmarks automatically.
However, one can manually build them as follows (assuming current directory is CSB):

```bash
cmake -S. -Bbuild
cmake --build build -j
```

They also can be run as tests, as follows:

```bash
ctest --test-dir build
```

## Command line arguments

The builtin benchmarks accept the following command line arguments:

- `-t=T`: where `T` is the number of threads created with `pthread_create`.
- `-n=N`: where `N` is the number of `nop` operations to run between real operations. This is helpful when less contention is desired.
- `-d=D`: where `D` is the duration of benchmark in seconds.
- `-s=S`: where `S` is an integer passed to the initialization function. Often `S` will be used as the initial size of (e.g. a data structure).
- `-op0=F`: where `F` specifies how often the operation with index `0` should be called in every `1024` operations.
    Note that when there is only one operation this should equal to `1024`. If there is more than one operation, then the sum of all frequencies
    should equal to `1024`. For example, say the benchmark has two operations, then one can pass `-op0=500 -op1=524` or `-op0=512 -op1=512` for
    an equal weight.

Here is how ctest will run `bm_empty`:

```bash
build/bm_empty "-t=12" "-n=0" "-d=1" "-s=0" "-op0=1024"
```

## Adding a new builtin benchmark

One can manually add a new builtin benchmark by creating a new C header. This header must implement
all functions specified in  `bench/include/CSB/bm_target.h`.

For a quick start,
copy `bench/targets/bm_empty.h` to a new file `bench/targets/my_bench.h`
and implement all the functions in there. Pay special attention to `bm_dispatch_operation`
as this is what the threads call on every iteration.


## Builtin benchmark output

The output of builtin benchmarks comply to what [bm-runner][] understands.
A `key=val;` format. `key` is either a name of a measured metric e.g. `throughput_min`
or a name of benchmark parameter e.g. `duration`.

The following is a sample output of `bm_empty`.

```bash
num_threads=12;init_sz=0;max_noise=0;duration=1;op0_dist=1024;algo_name=bm_empty;op0_nop_max=45591572;op0_nop_min=48;op0_nop_sum=33593277606;op0_nop_count=301374035;op0_nop_succ_count=301374035;op0_nop_skipped_count=0;op0_nop_avg=111.47;op0_nop_succ_percent=100.00;op0_nop_histogram=1065349,298380235,1348724,576159,308,72,25,18,8,12,2,2,12,5,1,0,1,1,54,498,495,262,127,77,50,62,111,35,34,135,107,55,30,409,78,15,115,44,22,12,16,15,97,48,22,7,6,9,5,7,3,1,4,4,3,2,2,2,1,20;univ_max=45591572;univ_min=48;univ_sum=33593277606;univ_count=301374035;univ_succ_count=301374035;univ_skipped_count=0;univ_avg=111.47;univ_succ_percent=100.00;throughput_max=301356.86886647;throughput_min=297071.55882159;throughput_max_ts=301379324.85379922;throughput_min_ts=297085649.67780507;ticks_to_ms=3792322;duration_max_ms=1014483;duration_max_clk=3847063730;duration_min_ms=1000057;duration_min_clk=3792255584;sys_time=11978;usr_time=12113860;max_rss_kb=2508;
```

_Note: `bm_empty` is an empty benchmarks that run `nop` instructions
in its operation. It is used a demo, and it can be used to analyze
the benchmarking skeleton behavior in isolation._

<!-- references -->
[config]: doc/CONFIG.md
[bench]: doc/bench.md
[bm-generator]: doc/bm-generator.md
[bm-runner]: doc/bm-runner.md
[benchkit]: https://github.com/open-s4c/benchkit
[fio]: https://github.com/axboe/fio
[stress-ng]: https://github.com/ColinIanKing/stress-ng
[will-it-scale]: https://github.com/antonblanchard/will-it-scale
