# CSB Generator

CSB generator found in bm-generator is a tool that extends [syzkaller][] and uses [tmplr][] to auto-generate benchmarks and JSON configuration files
compatible with the CSB framework [bm-runner][].

The generator takes an [strace][] log file as an input.

## Disclaimer
This tool is currently experimental and still in the prototype phase.

At the moment, users are expected to run benchmark generation scripts on the target machine, where the benchmarks
will be run and analyzed.

## Requirements

### Install golang

[syzkaller][] requires golang of version 1.25.x to be installed.

Critically, on Ubuntu 22.04, `apt install golang-go` uses version 18.1 which *does not* work.

You can install [golang][] as follows:
```bash
cd bm-generator/helper/
./install_go.sh
```

Make sure to add the golang binary directory to your PATH environment variable and re-login to your terminal session.
Put the following line into `$HOME/.bashrc`
```bash
export PATH=$PATH:/usr/local/go/bin
```

If installation fails, use the following instructions:

1. Verify if golang is installed with the correct version
```bash
go version
# result should be "go version go1.25.x ..."
```
2. If the version is incorrect *and* go is installed, then uninstall it with
  ```bash
  sudo apt remove golang-go
  ```
  - Check that has worked with
  ```bash
  ls /usr/local/go
  ```
  - If the directory is not empty, then uninstall it with:
  ```bash
  rm -rf /usr/local/go
  ```
3. Download golong from the official website:
```bash
wget https://go.dev/dl/go1.25.5.linux-amd64.tar.gz
```
  - Note: make sure that the file downloaded match your architecture (i.e., amd64 for x86-64 and arm64 for Arm).
4. Decompress file and place it in executables directory
```bash
tar -C /usr/local -xzf go1.25.5.linux-amd64.tar.gz
```
5. Add directory into PATH environment variable by adding the following line into `$HOME/.bashrc`
```bash
export PATH=$PATH:/usr/local/go/bin
```
  - Note: this change is only applied by closing and then reopening the terminal
6. Check that the correct golang was installed with
```bash
go version
# result should be "go version go1.25.x ..."
```

For more details, you can check the go installation website:
https://go.dev/doc/install


## Generating Benchmarks

The pipeline for generating benchmarks is implemented in
the following scripts:

|Script|Description|
|---|---|
|`00_init.sh`| Checks and possibly updates/installs golang as well as cloning the syzkaller repository. |
|`01_build.sh`| Builds the syzkaller tools necessary to automatically generate test cases from strace logs. |
|`02_parse.sh`| Parses an strace log file into the [syzlang][] internal representation of syzkaller. It outputs one [syzlang][] program per thread present in the strace log file. Output is stored in `deserialized/thread_<id1>.prog` |
|`03_extract.sh`| Analyzes all `deserialized/*.prog` [syzlang][] programs. For each input program, a dependency graph for all syscalls is computed. It outputs one [syzlang][] program per dependency graph into `extracted/min_<id2>.prog` |
|`04_prepare.sh`| Processes all `extracted/*.prog` [syzlang][] programs. Each input program is converted into a C header containing a function calling all dependent syscalls from the input [syzlang][] program. Output is stored in `../bench/targets/syz/min_<id3>.h` |
|`05_generate.sh`| Uses [tmplr][] to generate [bm-runner][] compatible headers and JSON configuration for all generated `../bench/targets/syz/min_<id3>.h` files. Output is stored as `../bench/targets/min_<id3>.h` header and `../../config/min_<id3>.json`. |

The only script that takes an argument is `02_parse.sh`, which needs a path to an strace log file generated as described below.
```bash
./02_parse.sh </path/to/strace.log>
```

### Collect strace

Use the following [strace][] command to collect `strace.log`.

_Note: replace `<app-binary>` with the name of your binary/application_

```bash
strace -o strace.log -a 1 -s 65500 -v -xx -f -Xraw --raw=wait4 <app-binary>
```

The scripts should be run in the same order they are enumerated:

```bash
cd bm-generator/
./00_init.sh
./01_build.sh
./02_parse.sh strace.log
./03_extract.sh
./04_prepare.sh
./05_generate.sh
```

## Deduplicating the set of autogenerated microbenchmarks:

The benchmarks generated by bm-generator may contain redundancy: for example, system call sequences that differ only in a file name in the same directory will be considered to be different, even though their effect on the system is the same.

To filter out such benchmarks, we introduce a pipeline based on flamegraph difference calculation:
- For each benchmark, the flamegraph is recorded and post-processed (see details below).
- Each of the collapsed stacks of the flamegraph is passed to `diffolded.pl` to calculate the difference of flamegraphs, and the maximum detected difference for a single stack (in either diff direction) is reported.
- Benchmarks which differ from each other by less than a certain threshold, are considered to be the same, and only of them is kept, while others are ignored.

Before passing the stacks to the `difffolded.pl` the flamegraph is postprocessed: in particular, the userspace stacks are dropped from the flamegraph, and only kernel stacks are kept.
Futhermore, the name of the benchmark application is replaced with a generic one: this allows side-stepping `difffolded.pl` limitation that permits calculation of the diff only for the applications with the same name.
This directly allows comparing the postprocessed flamegraphs of the autogenerated microbenchmarks with each other as well as with the postprocessed flamegraph of the original application.

### Workflow

To perform the deduplication, CSB provides a set of scripts in the `CSB/scripts/fg-diff` directory, driven by `./CSB/scripts/fg-diff/select-benchmarks.sh` script.
The operation workflow looks like the following:
```
$ cd CSB # this is important; the script will not work from a different directory
$ ./scripts/fg-diff/select-benchmarks.sh ./config/min_mysql_*.json
```
The last command takes as arguments the list of JSON config files of the microbenchmarks to execute for inclusion into the comparison.
In case no config files are provided, no new benchmarks are executed and only the results already present in the `results` directory are taken into account.

The output of the script is a list of benchmark names that are distinct from each other, according to the flamegraph difference criterion.

[strace]: https://github.com/strace/strace
[tmplr]: https://github.com/open-s4c/tmplr
[syzkaller]: https://github.com/open-s4c/syzkaller/tree/s4c/
[bm-runner]: doc/bm-runner.md
[golang]: https://go.dev/doc/install
[syzlang]: https://github.com/google/syzkaller/blob/master/docs/syscall_descriptions_syntax.md
